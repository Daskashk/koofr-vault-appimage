name: Build AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Clone Koofr Vault repository
      uses: actions/checkout@v4
      with:
        repository: koofr/vault
        path: vault-source
        submodules: recursive

    - name: Build Docker image
      run: |
        cd vault-source
        docker build -t vault-builder .

    - name: Extract UI from container
      run: |
        docker create --name vault_tmp vault-builder
        mkdir -p AppDir/bin AppDir/web
        docker cp vault_tmp:/app/dist/. AppDir/web/ 2>/dev/null ||
        docker cp vault_tmp:/app/vault-web/dist/. AppDir/web/ 2>/dev/null ||
        { echo "UI not found in container"; exit 1; }
        echo "UI files copied:"
        ls -1 AppDir/web | head
        docker rm vault_tmp

    - name: Install appimage-builder
      run: pip install appimage-builder

    - name: Create AppDir structure
      run: mkdir -p AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps

    - name: Create vault script
      run: |
        cat > AppDir/bin/vault << 'SCRIPT'
#!/usr/bin/env bash
HERE="$(dirname "$(readlink -f "$0")")"
export VAULT_WEB_PATH="${HERE}/../web"
if command -v python3 >/dev/null; then
  cd "$VAULT_WEB_PATH"
  python3 -m http.server 8080 --bind 127.0.0.1 &
  SERVER=$!
  xdg-open "http://127.0.0.1:8080" 2>/dev/null || echo "Open http://127.0.0.1:8080 manually"
  wait $SERVER
else
  echo "Python3 not available"
  exit 1
fi
SCRIPT
        chmod +x AppDir/bin/vault

    - name: Create desktop entry
      run: |
        cat > AppDir/usr/share/applications/net.koofr.vault.desktop << 'DESKTOP'
[Desktop Entry]
Type=Application
Name=Koofr Vault
Comment=Client-side encrypted folder for Koofr
Exec=bin/vault
Icon=net.koofr.vault
Categories=Utility;
DESKTOP

    - name: Create AppRun
      run: |
        cat > AppDir/AppRun << 'APPRUN'
#!/bin/sh
HERE="$(dirname "$(readlink -f "$0")")"
exec "${HERE}/bin/vault" "$@"
APPRUN
        chmod +x AppDir/AppRun

    - name: Download icon
      run: |
        wget -O AppDir/usr/share/icons/hicolor/256x256/apps/net.koofr.vault.png \
          https://raw.githubusercontent.com/koofr/vault/main/vault-web/public/favicon.ico \
          || echo "Icon not found"

    - name: Build AppImage
      run: appimage-builder --recipe AppImageBuilder.yml

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: Koofr-Vault-AppImage
        path: '*.AppImage*'

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: '*.AppImage*'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
