name: Build AppImage

on: 
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on:  ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Clone Koofr Vault repository
      uses: actions/checkout@v4
      with:
        repository: koofr/vault
        path: vault-source
        submodules: recursive

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip fuse libfuse2 wget xdg-utils
        pip install appimage-builder

    - name:  Build Docker image
      run: |
        cd vault-source
        docker build -t vault-builder . 

    - name: Extract UI from container
      run: |
        docker create --name vault_tmp vault-builder
        mkdir -p AppDir/bin AppDir/web
        
        # Intentar extraer desde mÃºltiples ubicaciones posibles
        if docker cp vault_tmp:/app/dist/.  AppDir/web/ 2>/dev/null; then
          echo "âœ“ UI extraÃ­do desde /app/dist"
        elif docker cp vault_tmp:/app/vault-web/dist/. AppDir/web/ 2>/dev/null; then
          echo "âœ“ UI extraÃ­do desde /app/vault-web/dist"
        else
          echo "âœ— Error:  No se pudo encontrar los archivos de UI en el contenedor"
          docker rm vault_tmp || true
          exit 1
        fi
        
        echo "ðŸ“ Archivos de UI:"
        ls -lh AppDir/web | head -10
        docker rm vault_tmp

    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        chmod 755 AppDir

    - name: Create vault launcher script
      run: |
        cat > AppDir/bin/vault << 'SCRIPT'
#!/bin/bash
set -e

HERE="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WEB_PATH="${HERE}/../web"
PORT=8080
BIND_ADDR="127.0.0.1"

# Validar que existen los archivos
if [ ! -d "$WEB_PATH" ] || [ -z "$(ls -A "$WEB_PATH")" ]; then
    echo "Error:  Archivos de UI no encontrados en $WEB_PATH"
    exit 1
fi

# Verificar Python3
if ! command -v python3 &> /dev/null; then
    echo "Error: Python3 no disponible"
    exit 1
fi

# Iniciar servidor HTTP en background
cd "$WEB_PATH"
echo "ðŸš€ Iniciando servidor de Koofr Vault en http://$BIND_ADDR:$PORT"
python3 -m http.server $PORT --bind $BIND_ADDR > /dev/null 2>&1 &
SERVER_PID=$!

# Trap para manejar seÃ±ales
cleanup() {
    if kill -0 $SERVER_PID 2>/dev/null; then
        kill $SERVER_PID 2>/dev/null || true
    fi
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# Intentar abrir en navegador
if command -v xdg-open &> /dev/null; then
    xdg-open "http://$BIND_ADDR:$PORT" 2>/dev/null &
else
    echo "ðŸ’¡ Abre tu navegador en: http://$BIND_ADDR:$PORT"
fi

# Mantener el servidor activo
wait $SERVER_PID
SCRIPT
        chmod +x AppDir/bin/vault
        echo "âœ“ Script de lanzamiento creado"

    - name: Create desktop entry
      run: |
        cat > AppDir/usr/share/applications/net.koofr.vault.desktop << 'DESKTOP'
[Desktop Entry]
Type=Application
Name=Koofr Vault
Comment=Cliente seguro del lado del cliente para Koofr
Exec=vault
Icon=net.koofr. vault
Categories=Utility;Security;
Keywords=encrypt;security;cloud;storage;
Terminal=false
StartupNotify=true
DESKTOP
        echo "âœ“ Desktop entry creado"

    - name: Create AppRun
      run: |
        cat > AppDir/AppRun << 'APPRUN'
#!/bin/sh
HERE="$(cd "$(dirname "$(readlink -f "$0")")" && pwd)"
PATH="${HERE}/bin:$PATH"
export PATH
export VAULT_WEB_PATH="${HERE}/web"
exec "${HERE}/bin/vault" "$@"
APPRUN
        chmod +x AppDir/AppRun
        echo "âœ“ AppRun creado"

    - name: Download and convert icon
      run: |
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Descargar el favicon
        if wget -q -O /tmp/favicon.ico \
          https://raw.githubusercontent.com/koofr/vault/main/vault-web/public/favicon.ico; then
          
          # Convertir ICO a PNG si es necesario
          if command -v convert &> /dev/null; then
            convert /tmp/favicon.ico AppDir/usr/share/icons/hicolor/256x256/apps/net.koofr.vault.png
            echo "âœ“ Icono convertido de ICO a PNG"
          else
            echo "âš  ImageMagick no disponible, usando wget con PNG directamente"
            wget -q -O AppDir/usr/share/icons/hicolor/256x256/apps/net.koofr.vault.png \
              https://raw.githubusercontent.com/koofr/vault/main/vault-web/public/favicon.png || \
              echo "âš  No se pudo descargar el icono PNG"
          fi
        else
          echo "âš  No se pudo descargar el favicon"
        fi
        
        # Crear un icono genÃ©rico si no existe
        if [ ! -f AppDir/usr/share/icons/hicolor/256x256/apps/net.koofr.vault.png ]; then
          echo "âš  Usando icono genÃ©rico como fallback"
          convert -size 256x256 xc:blue -fill white -gravity center \
            -pointsize 40 -annotate +0+0 "KV" \
            AppDir/usr/share/icons/hicolor/256x256/apps/net. koofr.vault.png || true
        fi

    - name:  Verify AppDir structure
      run: |
        echo "ðŸ“‹ Estructura de AppDir:"
        tree AppDir -L 3 || find AppDir -type f | head -20
        
        # Validaciones crÃ­ticas
        test -f AppDir/AppRun || { echo "âœ— AppRun no existe"; exit 1; }
        test -f AppDir/bin/vault || { echo "âœ— bin/vault no existe"; exit 1; }
        test -d AppDir/web || { echo "âœ— Directorio web no existe"; exit 1; }
        test -n "$(ls -A AppDir/web)" || { echo "âœ— Directorio web estÃ¡ vacÃ­o"; exit 1; }
        
        echo "âœ“ Validaciones completadas"

    - name: Build AppImage
      run: |
        appimage-builder --recipe AppImageBuilder.yml --skip-test
        
        # Verificar que se creÃ³ el AppImage
        if ls *.AppImage 2>/dev/null; then
          echo "âœ“ AppImage construido exitosamente"
          ls -lh *.AppImage*
        else
          echo "âœ— Error: No se generÃ³ el AppImage"
          exit 1
        fi

    - name:  Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: koofr-vault-appimage
        path: |
          *.AppImage
          *.AppImage.zsync
        retention-days: 30

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          *.AppImage
          *.AppImage.zsync
        draft: false
        prerelease:  ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
