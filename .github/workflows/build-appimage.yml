name: Build Koofr Vault AppImage (Funciona YA)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. Checkout TU configuración de Tauri
      - name: Checkout TU repo (tauri config)
        uses: actions/checkout@v4

      # 2. Checkout código fuente OFICIAL de Koofr
      - name: Checkout Koofr Vault oficial
        uses: actions/checkout@v4
        with:
          repository: koofr/vault
          submodules: recursive
          path: ./koofr-source

      # 3. Construir web con Docker (método oficial)
      - name: Construir web oficial
        run: |
          cd ./koofr-source
          docker build --build-arg GIT_REVISION=$(git rev-parse --short HEAD) \
                       --target static-stage -t vault-static .
          docker run --rm vault-static cat vault-web.tar.gz > ../web-files.tar.gz
          cd ..
          mkdir -p web-dist
          tar -xzf web-files.tar.gz -C web-dist
          echo "✅ Archivos web listos en web-dist/"

      # 4. Preparar Tauri con archivos e iconos OFICIALES
      - name: Preparar Tauri
        run: |
          # Mover archivos web
          mkdir -p tauri-app/web-dist
          cp -r web-dist/* tauri-app/web-dist/

          # COPIAR ICONOS OFICIALES del repo de Koofr
          mkdir -p tauri-app/src-tauri/icons
          cp -r ./koofr-source/vault-desktop/src-tauri/icons/* tauri-app/src-tauri/icons/

          # Crear tauri.conf.json si no existe
          if [ ! -f "tauri-app/src-tauri/tauri.conf.json" ]; then
            cat > tauri-app/src-tauri/tauri.conf.json << 'EOF'
{
  "productName": "Koofr Vault",
  "version": "1.0.0",
  "identifier": "net.koofr.vault",
  "build": {
    "beforeDevCommand": "",
    "beforeBuildCommand": "",
    "frontendDist": "../web-dist"
  },
  "app": {
    "withGlobalTauri": true
  },
  "bundle": {
    "active": true,
    "targets": ["appimage"],
    "icon": [
      "icons/32x32.png",
      "icons/128x128.png",
      "icons/128x128@2x.png",
      "icons/icon.icns",
      "icons/icon.ico"
    ]
  }
}
EOF
          else
            echo "✅ tauri.conf.json ya existe"
          fi

          # Verificar que los iconos se copiaron
          echo "✅ Iconos copiados:"
          ls -la tauri-app/src-tauri/icons/*.png | head -5

      # 5. Instalar dependencias mínimas
      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev

      # 6. Instalar Rust
      - name: Instalar Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      # 7. Construir AppImage (sin caché, más simple)
      - name: Construir AppImage
        run: |
          cd tauri-app
          npm install || npm init -y && npm install @tauri-apps/cli @tauri-apps/api
          cd src-tauri
          cargo install tauri-cli --version "^2.0.0"
          cargo tauri build --bundles appimage
        env:
          TAURI_NON_INTERACTIVE: "true"

      # 8. Subir resultado
      - name: Subir AppImage
        uses: actions/upload-artifact@v4
        with:
          name: KoofrVault-AppImage
          path: tauri-app/src-tauri/target/release/bundle/appimage/*.AppImage
