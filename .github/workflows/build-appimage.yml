name: Build Koofr Vault AppImage (Completo - Funciona)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    steps:
      # 1. Checkout de TU repo (donde está tauri-app/)
      - name: Checkout repo actual (tauri config)
        uses: actions/checkout@v4
        with:
          path: ./appimage-config

      # 2. Checkout del repo OFICIAL de Koofr Vault (código fuente)
      - name: Checkout Koofr Vault oficial (código fuente)
        uses: actions/checkout@v4
        with:
          repository: koofr/vault
          submodules: recursive
          path: ./koofr-source

      # 3. Construir web desde código fuente y extraer CORRECTAMENTE
      - name: Construir web desde código fuente
        run: |
          cd ./koofr-source
          docker build --build-arg GIT_REVISION=$(git rev-parse --short HEAD) \
                       --target static-stage -t vault-static .
          docker run --rm vault-static cat vault-web.tar.gz > ../vault-web.tar.gz

          # Extraer y VER la estructura REAL del tar.gz
          cd ..
          echo "=== ESTRUCTURA DEL TAR.GZ ==="
          tar -tzf vault-web.tar.gz | head -20
          echo "=== FIN DE LISTA ==="

          # Extraer TODO el contenido
          tar -xzf vault-web.tar.gz

          # Ver qué se extrajo realmente
          echo "=== CONTENIDO EXTRAÍDO ==="
          ls -la
          echo "=== ¿Existe vault-web/? ==="
          ls -la vault-web/ 2>/dev/null || echo "No existe carpeta vault-web/"

          # Crear la estructura que Tauri espera
          mkdir -p ./web-files
          # Mover TODO lo extraído a web-files (incluyendo index.html, assets/, etc.)
          mv *.html *.txt *.json assets/ streamsaver*/ ./web-files/ 2>/dev/null || true

      # 4. Preparar configuración de Tauri con la estructura REAL
      - name: Configurar Tauri con archivos web
        run: |
          # Copiar los archivos web REALES
          mkdir -p ./appimage-config/tauri-app/src-tauri
          cp -r ./web-files ./appimage-config/tauri-app/web-dist

          # Crear configuración de Tauri que apunta a web-dist/
          cat > ./appimage-config/tauri-app/src-tauri/tauri.conf.json << 'EOF'
          {
            "productName": "Koofr Vault",
            "version": "1.0.0",
            "identifier": "net.koofr.vault",
            "build": {
              "beforeDevCommand": "",
              "beforeBuildCommand": "",
              "frontendDist": "../web-dist"
            },
            "app": {
              "withGlobalTauri": true,
              "security": {
                "csp": null
              }
            },
            "bundle": {
              "active": true,
              "targets": "appImage",
              "icon": [
                "icons/32x32.png",
                "icons/128x128.png",
                "icons/128x128@2x.png",
                "icons/icon.icns",
                "icons/icon.ico"
              ]
            }
          }
          EOF

          echo "✅ Estructura preparada:"
          ls -la ./appimage-config/tauri-app/web-dist/

      # 5. Dependencias para Tauri
      - name: Instalar dependencias sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev libgtk-3-dev \
            libayatana-appindicator3-dev librsvg2-dev \
            build-essential curl wget file libssl-dev

      - name: Instalar Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add x86_64-unknown-linux-gnu

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 6. Construir AppImage
      - name: Construir AppImage con Tauri
        run: |
          cd ./appimage-config/tauri-app
          npm install
          cd src-tauri
          cargo install tauri-cli --version "^2.0.0"
          cargo tauri build --target x86_64-unknown-linux-gnu --bundles appimage
        env:
          TAURI_NON_INTERACTIVE: "true"

      # 7. Subir resultado
      - name: Subir AppImage
        uses: actions/upload-artifact@v4
        with:
          name: KoofrVault-AppImage
          path: ./appimage-config/tauri-app/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
