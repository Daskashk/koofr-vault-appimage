name: Build Koofr Vault AppImage

# ðŸŽ¯ TRIGGERS: Se ejecuta MANUALMENTE o al crear un TAG (ej: v1.0.0)
on:
  workflow_dispatch:   # Permite ejecuciÃ³n manual desde la pestaÃ±a "Actions"
  push:
    tags: ['v*']       # Se activa automÃ¡ticamente al subir un tag que empiece por 'v'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout TU repo
        uses: actions/checkout@v4

      - name: Checkout Koofr Vault oficial
        uses: actions/checkout@v4
        with:
          repository: koofr/vault
          submodules: recursive
          path: koofr-source

      - name: Construir web oficial
        run: |
          cd koofr-source
          docker build --build-arg GIT_REVISION=$(git rev-parse --short HEAD) --target static-stage -t vault-static .
          docker run --rm vault-static cat vault-web.tar.gz > ../vault-web.tar.gz
          cd ..
          tar -xzf vault-web.tar.gz

      - name: Preparar Tauri
        run: |
          mkdir -p tauri-app/web-dist
          mv index.html gitrevision.txt config.json assets/ streamsaver*/ tauri-app/web-dist/ 2>/dev/null || true

          mkdir -p tauri-app/src-tauri/icons
          cp koofr-source/vault-desktop/src-tauri/icons/* tauri-app/src-tauri/icons/

          # Crear tauri.conf.json COMPATIBLE con TAURI 1.x
          cat > tauri-app/src-tauri/tauri.conf.json << 'EOF'
          {
            "package": {
              "productName": "Koofr Vault",
              "version": "1.0.0"
            },
            "build": {
              "distDir": "../web-dist",
              "devPath": "http://localhost:8080",
              "beforeDevCommand": "",
              "beforeBuildCommand": ""
            },
            "tauri": {
              "bundle": {
                "active": true,
                "targets": "appimage",
                "identifier": "net.koofr.vault",
                "icon": [
                  "icons/32x32.png",
                  "icons/128x128.png",
                  "icons/128x128@2x.png",
                  "icons/icon.icns",
                  "icons/icon.ico"
                ]
              },
              "allowlist": {
                "all": true
              },
              "windows": [
                {
                  "title": "Koofr Vault",
                  "width": 1280,
                  "height": 800
                }
              ]
            }
          }
          EOF
          echo "âœ… ConfiguraciÃ³n de Tauri 1.x creada"

      - name: Instalar dependencias del sistema (CON libsoup-3.0)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.0-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsoup-3.0-dev

      - name: Setup Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add x86_64-unknown-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar Tauri (VERSION 1.x para Ubuntu 22.04)
        run: |
          cd tauri-app
          npm install @tauri-apps/cli@1.6.2 @tauri-apps/api@1.6.0

      - name: Construir AppImage
        run: |
          cd tauri-app
          npx tauri build --bundles appimage
        env:
          TAURI_NON_INTERACTIVE: "true"

      # ðŸ”’ CORRECCIÃ“N DE PERMISOS (antes de subir)
      - name: Asegurar permisos de ejecuciÃ³n del AppImage
        run: |
          chmod +x tauri-app/src-tauri/target/release/bundle/appimage/*.AppImage

      - name: Subir AppImage como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: KoofrVault-AppImage
          path: tauri-app/src-tauri/target/release/bundle/appimage/*.AppImage

  # ðŸš€ NUEVO JOB: Crear Release automÃ¡tico en GitHub
  release:
    needs: build  # Depende del job 'build'
    runs-on: ubuntu-latest
    # âš ï¸ PERMISO CRÃTICO para poder crear releases
    permissions:
      contents: write
    steps:
      - name: Descargar artefacto (AppImage)
        uses: actions/download-artifact@v4
        with:
          name: KoofrVault-AppImage

      - name: Crear Release en GitHub
        # Esta acciÃ³n crea un release oficial y adjunta el AppImage
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')  # Solo si se activÃ³ por un TAG
        with:
          files: Koofr_Vault*.AppImage
          generate_release_notes: true
