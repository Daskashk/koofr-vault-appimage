name: Build Koofr Vault AppImage

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout TU repo
        uses: actions/checkout@v4

      - name: Checkout Koofr Vault oficial
        uses: actions/checkout@v4
        with:
          repository: koofr/vault
          submodules: recursive
          path: koofr-source

      - name: Construir web oficial
        run: |
          cd koofr-source
          docker build --build-arg GIT_REVISION=$(git rev-parse --short HEAD) --target static-stage -t vault-static .
          docker run --rm vault-static cat vault-web.tar.gz > ../vault-web.tar.gz
          cd ..
          tar -xzf vault-web.tar.gz

      - name: Preparar Tauri
        run: |
          mkdir -p tauri-app/web-dist
          mv index.html gitrevision.txt config.json assets/ streamsaver*/ tauri-app/web-dist/ 2>/dev/null || true

          mkdir -p tauri-app/src-tauri/icons
          cp koofr-source/vault-desktop/src-tauri/icons/* tauri-app/src-tauri/icons/

          # Corregir Cargo.toml: Eliminar la feature 'shell-open' que ya no existe en Tauri 2.0
          sed -i 's/features = \["shell-open"\]//' tauri-app/src-tauri/Cargo.toml

          echo '{' > tauri-app/src-tauri/tauri.conf.json
          echo '  "productName": "Koofr Vault",' >> tauri-app/src-tauri/tauri.conf.json
          echo '  "version": "1.0.0",' >> tauri-app/src-tauri/tauri.conf.json
          echo '  "identifier": "net.koofr.vault",' >> tauri-app/src-tauri/tauri.conf.json
          echo '  "build": {' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "beforeDevCommand": "",' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "beforeBuildCommand": "",' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "frontendDist": "../web-dist"' >> tauri-app/src-tauri/tauri.conf.json
          echo '  },' >> tauri-app/src-tauri/tauri.conf.json
          echo '  "app": {' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "withGlobalTauri": true' >> tauri-app/src-tauri/tauri.conf.json
          echo '  },' >> tauri-app/src-tauri/tauri.conf.json
          echo '  "bundle": {' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "active": true,' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "targets": ["appimage"],' >> tauri-app/src-tauri/tauri.conf.json
          echo '    "icon": [' >> tauri-app/src-tauri/tauri.conf.json
          echo '      "icons/32x32.png",' >> tauri-app/src-tauri/tauri.conf.json
          echo '      "icons/128x128.png",' >> tauri-app/src-tauri/tauri.conf.json
          echo '      "icons/128x128@2x.png",' >> tauri-app/src-tauri/tauri.conf.json
          echo '      "icons/icon.icns",' >> tauri-app/src-tauri/tauri.conf.json
          echo '      "icons/icon.ico"' >> tauri-app/src-tauri/tauri.conf.json
          echo '    ]' >> tauri-app/src-tauri/tauri.conf.json
          echo '  }' >> tauri-app/src-tauri/tauri.conf.json
          echo '}' >> tauri-app/src-tauri/tauri.conf.json

      - name: Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Setup Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add x86_64-unknown-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar Tauri (VERSIONES EXACTAS)
        run: |
          cd tauri-app
          npm init -y
          npm install @tauri-apps/cli@2.0.0 @tauri-apps/api@2.0.0

      - name: Construir AppImage
        run: |
          cd tauri-app
          npx tauri build --bundles appimage
        env:
          TAURI_NON_INTERACTIVE: "true"

      - name: Subir AppImage
        uses: actions/upload-artifact@v4
        with:
          name: KoofrVault-AppImage
          path: tauri-app/src-tauri/target/release/bundle/appimage/*.AppImage
