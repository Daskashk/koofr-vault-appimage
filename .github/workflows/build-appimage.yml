name: Build Koofr Vault AppImage (Tauri 2.0)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-appimage:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Construir archivos web estáticos con Docker
        run: |
          docker build --build-arg GIT_REVISION=$(git rev-parse --short HEAD) \
                       --target static-stage -t vault-static .
          docker run --rm vault-static cat vault-web.tar.gz > vault-web.tar.gz
          tar -xzf vault-web.tar.gz

      - name: Configurar Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          rustup target add x86_64-unknown-linux-gnu

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias de Tauri y construir AppImage
        run: |
          cd tauri-app
          npm install
          cd src-tauri
          cargo install tauri-cli --version "^2.0.0"
          cargo tauri build --target x86_64-unknown-linux-gnu --bundles appimage
        env:
          DEBIAN_FRONTEND: noninteractive
          TAURI_NON_INTERACTIVE: "true"

      - name: Subir artefacto (AppImage)
        uses: actions/upload-artifact@v4
        with:
          name: KoofrVault-AppImage
          path: tauri-app/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
          retention-days: 7

      - name: Crear Release en GitHub
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: tauri-app/src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
          generate_release_notes: true
