name: Build AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Clone Koofr Vault repo
      uses: actions/checkout@v4
      with:
        repository: koofr/vault
        path: vault-source
        submodules: recursive

    - name: Build Docker image
      run: |
        cd vault-source
        docker build -t vault-builder .

    - name: Extract built UI
      run: |
        # container for extraction
        docker create --name vault_tmp vault-builder
        mkdir -p AppDir/web
        docker cp vault_tmp:/app/dist/. AppDir/web/
        ls -la AppDir/web   # verifica que haya archivos
        docker rm vault_tmp

    - name: Install appimage-builder
      run: pip install appimage-builder

    - name: Assemble AppImage
      run: |
        mkdir -p AppDir/usr/share/applications \
                 AppDir/usr/share/icons/hicolor/256x256/apps

        # launcher script (lanza Python http server)
        cat > AppDir/bin/vault <<'SCRIPT'
        #!/usr/bin/env bash
        HERE="$(dirname "$(readlink -f "$0")")"
        export VAULT_WEB_PATH="${HERE}/../web"
        if command -v python3 >/dev/null; then
          cd "$VAULT_WEB_PATH"
          python3 -m http.server 8080 --bind 127.0.0.1 &
          SERVER=$!
          xdg-open "http://127.0.0.1:8080" || echo "Open http://127.0.0.1:8080"
          wait $SERVER
        else
          echo "Python3 not found"
          exit 1
        fi
        SCRIPT
        chmod +x AppDir/bin/vault

        # desktop entry
        cat > AppDir/usr/share/applications/net.koofr.vault.desktop <<'DESKTOP'
        [Desktop Entry]
        Type=Application
        Name=Koofr Vault
        Comment=Client‑side encrypted folder for Koofr
        Exec=bin/vault
        Icon=net.koofr.vault
        Categories=Utility;
        DESKTOP

        # AppRun (wrapper)
        cat > AppDir/AppRun <<'APPRUN'
        #!/bin/sh
        HERE="$(dirname "$(readlink -f "$0")")"
        exec "${HERE}/bin/vault" "$@"
        APPRUN
        chmod +x AppDir/AppRun

        # icon (fallback if missing)
        wget -O AppDir/usr/share/icons/hicolor/256x256/apps/net.koofr.vault.png \
          https://raw.githubusercontent.com/koofr/vault/main/vault-web/public/favicon.ico \
          || echo "Icon not found – using placeholder"

        # build AppImage
        appimage-builder --recipe AppImageBuilder.yml

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: Koofr-Vault-AppImage
        path: '*.AppImage*'

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: '*.AppImage*'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
